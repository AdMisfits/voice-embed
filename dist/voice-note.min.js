"use strict";(()=>{var p=class extends HTMLElement{constructor(){super();this.ctx=null;this.audioContext=null;this.isPlaying=!1;this.peaks=[];this.animationFrame=null;this.hasUserInteracted=!1;this.currentProgress=0;this.isGeneratingWaveform=!1;this.cacheKey="";this.hoveredBar=null;this.clickedBar=null;this.speeds=[1,1.25,1.5,2];this.currentSpeedIndex=0;this.shadow=this.attachShadow({mode:"open"}),this.audio=document.createElement("audio"),this.audio.preload="metadata",this.audio.crossOrigin="anonymous",this.playButton=document.createElement("button"),this.timeDisplay=document.createElement("span"),this.speedButton=document.createElement("button"),this.canvas=document.createElement("canvas"),this.container=document.createElement("div"),this.setupDOM(),this.attachEventListeners()}static get observedAttributes(){return["src"]}setupDOM(){let t=document.createElement("style");t.textContent=`
      :host {
        display: inline-block;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      * {
        box-sizing: border-box;
      }

      .container {
        background: #007AFF;
        border-radius: 1rem;
        padding: 8px;
        padding-top: 10px;
        padding-bottom: 10px;
        display: inline-flex;
        align-items: center;
        position: relative;
        overflow: visible;
      }

      .play-button {
        background: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
        padding: 0;
        transition: transform 0.1s;
        margin-right: 8px;
      }

      .play-button:active {
        transform: scale(0.95);
      }

      .play-button:focus {
        outline: none;
      }

      .play-icon,
      .pause-icon {
        width: 16px;
        height: 16px;
        fill: #007AFF;
      }

      .pause-icon {
        display: none;
        width: 14px;
        height: 14px;
      }

      .play-button[aria-pressed="true"] .play-icon {
        display: none;
      }

      .play-button[aria-pressed="true"] .pause-icon {
        display: block;
      }

      .waveform-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: stretch;
        position: relative;
        min-width: 120px;
        max-width: 160px;

      }

      .waveform-canvas {
        width: 100%;
        height: 28px;
        cursor: pointer;
        display: block;
      }

      .time-display {
        position: absolute;
        bottom: -6px;
        left: 0;
        color: white;
        font-size: 9px;
        font-weight: 500;
        opacity: 0.85;
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
      }

      .speed-button {
        background: transparent;
        border: none;
        color: white;
        font-size: 11px;
        font-weight: 600;
        opacity: 0.7;
        cursor: pointer;
        padding: 4px 1px;
        margin-left: 4px;
        border-radius: 6px;
        transition: opacity 0.2s, background 0.2s;
        white-space: nowrap;
        min-width: 32px;
        text-align: center;
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
        align-self: center;
        box-sizing: content-box;
      }

      .speed-button:hover {
        opacity: 0.9;
        background: rgba(255, 255, 255, 0.1);
      }

      .speed-button:active {
        opacity: 1;
        background: rgba(255, 255, 255, 0.15);
      }

      .speed-button:focus {
        outline: none;
      }

      .loading {
        opacity: 0.6;
      }

      .error-state {
        background: #FF3B30;
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          transition: none !important;
          animation: none !important;
        }
      }
    `,this.container.className="container",this.container.setAttribute("role","region"),this.container.setAttribute("aria-label","Voice message"),this.playButton.className="play-button",this.playButton.setAttribute("aria-label","Play"),this.playButton.setAttribute("aria-pressed","false"),this.playButton.innerHTML=`
      <svg class="play-icon" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z"/>
      </svg>
      <svg class="pause-icon" viewBox="0 0 24 24">
        <rect x="6" y="4" width="4" height="16"/>
        <rect x="14" y="4" width="4" height="16"/>
      </svg>
    `,this.canvas.className="waveform-canvas",this.timeDisplay.className="time-display",this.timeDisplay.textContent="0:00",this.speedButton.className="speed-button",this.speedButton.textContent="1\xD7",this.speedButton.setAttribute("aria-label","Playback speed"),this.speedButton.setAttribute("title","Change playback speed");let e=document.createElement("div");e.className="waveform-wrapper",e.appendChild(this.canvas),e.appendChild(this.timeDisplay),this.container.appendChild(this.playButton),this.container.appendChild(e),this.container.appendChild(this.speedButton),this.shadow.appendChild(t),this.shadow.appendChild(this.container),this.shadow.appendChild(this.audio)}attachEventListeners(){this.playButton.addEventListener("click",()=>this.togglePlayPause()),this.speedButton.addEventListener("click",()=>this.cycleSpeed()),this.audio.addEventListener("loadedmetadata",async()=>{this.timeDisplay.textContent=this.formatTime(this.audio.duration),await this.generateWaveform(),this.drawWaveform(),this.dispatchEvent(new CustomEvent("vn-ready"))}),this.audio.addEventListener("timeupdate",()=>{this.isPlaying&&(this.timeDisplay.textContent=this.formatTime(this.audio.currentTime)),this.currentProgress=this.audio.currentTime/this.audio.duration,this.drawWaveform(),this.dispatchEvent(new CustomEvent("vn-timeupdate",{detail:{currentTime:this.audio.currentTime,duration:this.audio.duration}}))}),this.audio.addEventListener("ended",()=>{this.isPlaying=!1,this.playButton.setAttribute("aria-pressed","false"),this.audio.currentTime=0,this.currentProgress=0,this.timeDisplay.textContent=this.formatTime(this.audio.duration),this.clickedBar=null,this.drawWaveform(),this.dispatchEvent(new CustomEvent("vn-ended"))}),this.audio.addEventListener("error",()=>{var e;let t=this.audio.error;this.handleError(((e=t==null?void 0:t.code)==null?void 0:e.toString())||"unknown",(t==null?void 0:t.message)||"Audio failed to load")}),this.canvas.addEventListener("click",t=>{let e=this.canvas.getBoundingClientRect(),a=t.clientX-e.left,r=Math.floor(a/(2+1));this.clickedBar=r;let o=a/e.width;this.seek(this.audio.duration*o),this.drawWaveform()}),this.canvas.addEventListener("mousemove",t=>{let e=this.canvas.getBoundingClientRect(),a=t.clientX-e.left,r=Math.floor(a/(2+1));this.hoveredBar!==r&&(this.hoveredBar=r,this.drawWaveform())}),this.canvas.addEventListener("mouseleave",()=>{this.hoveredBar!==null&&(this.hoveredBar=null,this.drawWaveform())}),this.addEventListener("keydown",t=>{switch(t.key){case" ":case"Enter":t.preventDefault(),this.togglePlayPause();break;case"ArrowLeft":t.preventDefault(),this.seek(Math.max(0,this.audio.currentTime-5));break;case"ArrowRight":t.preventDefault(),this.seek(Math.min(this.audio.duration,this.audio.currentTime+5));break}})}connectedCallback(){let t=this.getAttribute("src");if(t){this.audio.src=t,this.cacheKey=`voice-note-peaks-${t}`;let e=localStorage.getItem(this.cacheKey);if(e)try{this.peaks=JSON.parse(e)}catch{this.peaks=[]}}this.setupCanvasSize(),this.ctx=this.canvas.getContext("2d"),this.drawWaveform()}setupCanvasSize(){requestAnimationFrame(()=>{let t=this.canvas.getBoundingClientRect(),e=window.devicePixelRatio||1;this.canvas.width=t.width*e,this.canvas.height=t.height*e,this.ctx=this.canvas.getContext("2d"),this.drawWaveform()})}disconnectedCallback(){this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}attributeChangedCallback(t,e,a){if(e!==a)switch(t){case"src":a&&(this.load(a),this.cacheKey=`voice-note-peaks-${a}`);break}}async generateWaveform(){if(!(this.isGeneratingWaveform||this.peaks.length>0)){this.isGeneratingWaveform=!0,this.container.classList.add("loading");try{let e=await(await fetch(this.audio.src)).arrayBuffer();this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));let s=(await this.audioContext.decodeAudioData(e.slice(0))).getChannelData(0),i=80,r=Math.floor(s.length/i),o=[];for(let h=0;h<i;h++){let n=0;for(let c=0;c<r;c++)n+=Math.abs(s[h*r+c]);o.push(n/r)}let d=Math.max(...o);this.peaks=o.map(h=>h/d),localStorage.setItem(this.cacheKey,JSON.stringify(this.peaks))}catch{this.peaks=this.generateFallbackPeaks()}finally{this.isGeneratingWaveform=!1,this.container.classList.remove("loading"),this.setupCanvasSize()}}}generateFallbackPeaks(){let t=[];for(let e=0;e<80;e++)t.push(.3+Math.random()*.7);return t}drawWaveform(){if(!this.ctx)return;let t=this.canvas.getBoundingClientRect(),e=window.devicePixelRatio||1,a=t.width,s=t.height,i=2,r=1,o=Math.floor(a/(i+r));if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.peaks.length===0){for(let n=0;n<o;n++){let c=n*(i+r),l=s*.3,u=(s-l)/2;this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.drawRoundedBar(c*e,u*e,i*e,l*e)}return}let d=Math.min(o,this.peaks.length),h=Math.floor(d*this.currentProgress);for(let n=0;n<d;n++){let c=Math.floor(n*this.peaks.length/d),l=this.peaks[c],u=n*(i+r),m=Math.max(4,l*s*.7),v=(s-m)/2;n===this.clickedBar?this.ctx.fillStyle="rgba(255, 255, 255, 1)":n===this.hoveredBar?this.ctx.fillStyle="rgba(255, 255, 255, 0.7)":n<h?this.ctx.fillStyle="white":this.ctx.fillStyle="rgba(255, 255, 255, 0.4)",this.drawRoundedBar(u*e,v*e,i*e,m*e)}}drawRoundedBar(t,e,a,s){if(!this.ctx)return;let i=a/2;if(s<=a){this.ctx.beginPath(),this.ctx.arc(t+i,e+s/2,s/2,0,Math.PI*2),this.ctx.fill();return}this.ctx.beginPath(),this.ctx.moveTo(t+i,e),this.ctx.lineTo(t+a-i,e),this.ctx.arc(t+a-i,e+i,i,-Math.PI/2,0),this.ctx.lineTo(t+a,e+s-i),this.ctx.arc(t+a-i,e+s-i,i,0,Math.PI/2),this.ctx.lineTo(t+i,e+s),this.ctx.arc(t+i,e+s-i,i,Math.PI/2,Math.PI),this.ctx.lineTo(t,e+i),this.ctx.arc(t+i,e+i,i,Math.PI,Math.PI*1.5),this.ctx.closePath(),this.ctx.fill()}formatTime(t){if(isNaN(t))return"0:00";let e=Math.floor(t/60),a=Math.floor(t%60);return`${e}:${a.toString().padStart(2,"0")}`}togglePlayPause(){this.hasUserInteracted||(this.hasUserInteracted=!0),this.isPlaying?this.pause():this.play()}cycleSpeed(){this.currentSpeedIndex=(this.currentSpeedIndex+1)%this.speeds.length;let t=this.speeds[this.currentSpeedIndex];this.audio.playbackRate=t,this.updateSpeedDisplay()}updateSpeedDisplay(){let t=this.speeds[this.currentSpeedIndex];t===1?this.speedButton.textContent="1\xD7":t===1.25?this.speedButton.textContent="1.25\xD7":t===1.5?this.speedButton.textContent="1.5\xD7":t===2&&(this.speedButton.textContent="2\xD7")}handleError(t,e){this.container.classList.add("error-state"),this.dispatchEvent(new CustomEvent("vn-error",{detail:{code:t,message:e}}))}play(){return this.audio.play().then(()=>{this.isPlaying=!0,this.playButton.setAttribute("aria-pressed","true"),this.playButton.setAttribute("aria-label","Pause"),this.dispatchEvent(new CustomEvent("vn-play"))})}pause(){this.audio.pause(),this.isPlaying=!1,this.playButton.setAttribute("aria-pressed","false"),this.playButton.setAttribute("aria-label","Play"),this.timeDisplay.textContent=this.formatTime(this.audio.currentTime),this.dispatchEvent(new CustomEvent("vn-pause"))}seek(t){if(!isNaN(t)&&t>=0&&t<=this.audio.duration){this.audio.currentTime=t,this.currentProgress=t/this.audio.duration;let e=this.canvas.getBoundingClientRect(),i=Math.floor(e.width/(2+1));this.clickedBar=Math.floor(i*this.currentProgress),this.drawWaveform(),this.timeDisplay.textContent=this.formatTime(t)}}load(t){if(t){this.audio.src=t,this.cacheKey=`voice-note-peaks-${t}`,this.peaks=[];let e=localStorage.getItem(this.cacheKey);if(e)try{this.peaks=JSON.parse(e),this.setupCanvasSize()}catch{this.peaks=[]}}this.audio.load(),this.isPlaying=!1,this.playButton.setAttribute("aria-pressed","false"),this.currentProgress=0,this.currentSpeedIndex=0,this.audio.playbackRate=1,this.updateSpeedDisplay()}get currentTime(){return this.audio.currentTime}set currentTime(t){this.audio.currentTime=t}get duration(){return this.audio.duration}get paused(){return this.audio.paused}get playbackRate(){return this.audio.playbackRate}set playbackRate(t){this.audio.playbackRate=t}};customElements.define("voice-note",p);})();
